% MODERN LuaLaTeX SETUP & FONTS
\NeedsTeXFormat{LaTeX2e}
\usepackage{silence}
\WarningFilter{latex}{Command \showhyphens has changed}

% =============================================
% 1. CORE PACKAGES
% =============================================
\usepackage{fontspec}         % Font selection for LuaLaTeX
\usepackage[final]{microtype} % Better typography
\usepackage[english]{babel} % Language support (Norwegian)
\usepackage{xcolor} % Required for colors

% =============================================
% 2. TEXT & TYPOGRAPHY
% =============================================
\usepackage{ragged2e}        % Better text alignment
\usepackage{enumitem}        % Customize lists
\usepackage{suffix}          % Command suffix support
\usepackage[backend=biber]{biblatex}  % Bibliography management
\addbibresource{backmatter/references.bib}

% =============================================
% 3. TABLE & FIGURE SUPPORT
% =============================================
% Table packages
\usepackage{booktabs}        % Professional tables
\usepackage{tabularx}        % Flexible tables
\usepackage{array}           % Extended array features
\usepackage{colortbl}        % Table colors
\usepackage{multirow}        % Multiple row cells
\usepackage{siunitx}         % Units and number formatting

% Figure packages
\usepackage{float}           % Float control
\usepackage{subcaption}      % Sub-figures support
\usepackage[autostyle, english=american]{csquotes}  % Smart quotes

% =============================================
% 4. MATH & ALGORITHMS
% =============================================
% Math packages
\usepackage{mathtools}
\usepackage[math-style=ISO, warnings-off={mathtools-colon, mathtools-overbracket}]{unicode-math}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amsthm}

% Custom math commands
\newcommand{\ep}{\varepsilon}
\newcommand{\vp}{\varphi}
\newcommand{\cond}{\operatorname{cond}}
\newcommand{\argmin}{\operatorname{argmin}}
\newcommand{\argmax}{\operatorname{argmax}}
\newcommand{\bm}[1]{\symbf{#1}}
\newcommand{\bmat}[1]{\begin{bmatrix}#1\end{bmatrix}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\dd}[2][]{\frac{d#1}{d{#2}}}
\newcommand{\ddn}[3][]{\frac{d^{#2}#1}{d{#3}^{#2}}}
\newcommand{\spann}{\operatorname{span}}
\newcommand{\diag}{\operatorname{diag}}
\newcommand{\tr}{\operatorname{tr}}
\newcommand{\rank}{\operatorname{rank}}
\newcommand{\adj}{\operatorname{adj}}
\newcommand{\col}{\operatorname{col}}
\newcommand{\row}{\operatorname{row}}
\newcommand{\range}{\operatorname{range}}

% symbols
\newcommand{\myqedsymbol}{\textcolor{thm-color}{\(\blacksquare\))}}
\newcommand{\To}{\nearrow}

\DeclarePairedDelimiter{\inner}{\langle}{\rangle}
\DeclarePairedDelimiter{\norm}{\lVert}{\rVert}
\DeclarePairedDelimiter{\abs}{\lvert}{\rvert}

\setmainfont{Fira Sans}
\setsansfont{IBM Plex Sans Condensed}
\setmonofont{Fira Code}
\setmathfont{Fira Math}[Scale=MatchLowercase]
\setmathfont[range={\mathcal,\mathscr,\mathbb,\mathfrak,\top,\Re,\Im,\ddots,\vdots,\setminus,\triangleright}]{STIX Two Math}
\usepackage{silence}
\WarningFilter{latexfont}{Font shape}

% Algorithm support
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
% algorithm package settings
% custom comment style



% =============================================
% 5. PAGE LAYOUT & HYPERREF
% =============================================
\usepackage[most]{tcolorbox}
\usepackage[
  headheight=15pt,
  margin=2.5cm,
  includeheadfoot
]{geometry}
\usepackage{parskip}
% Page headers and footers
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{} % Clear all header and footer fields
\fancyhead[L]{\leftmark}
\fancyhead[R]{\thepage}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}

% Table of contents formatting
\usepackage{tocloft}
\renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}
\setlength{\cftbeforesecskip}{2pt}
\renewcommand{\cftsecfont}{\normalfont}
\renewcommand{\cftsecpagefont}{\normalfont}

% Hyperref
\usepackage[colorlinks]{hyperref}
\usepackage{bookmark} % Clickable bookmarks in PDF
\hypersetup{
  colorlinks=true,
  linkcolor=blue,
  filecolor=magenta,
  urlcolor=cyan,
  pdftitle={Modern LaTeX Setup},
  pdfauthor={Trym SÃ¦ther},
  pdfsubject={Modern LaTeX Setup},
  pdfkeywords={LaTeX, modern, setup}
}

% Glossary setup
\usepackage[acronym,symbols,nogroupskip,hyperfirst=true]{glossaries-extra}  % Glossary support with hyperlinks
\setglossarystyle{listhypergroup}  % Enable hyperlinks in glossary style

% =============================================
% 6. COLOR & THEOREM ENVIRONMENTS
% =============================================

% Color definitions
% Theorem environments colors
\definecolor{def-color}{HTML}{E40125}    % Bright red
\definecolor{thm-color}{HTML}{1346E4}    % Royal blue
\definecolor{lem-color}{HTML}{05C4D9}    % Light blue/cyan
\definecolor{exm-color}{HTML}{21340A}    % Very dark green
\definecolor{rem-color}{HTML}{18B640}    % Medium green
\definecolor{prop-color}{HTML}{9C27B0}    % Purple
\definecolor{cor-color}{HTML}{FF5722}     % Deep Orange
\definecolor{alg-color}{HTML}{37474F}     % Dark blue-gray
\definecolor{mot-color}{HTML}{9C27B0} % Vibrant magenta/purple

% Random colors
\definecolor{filing-color}{HTML}{607D8B}    % Blue Grey
\definecolor{railing-color}{HTML}{795548}   % Brown
\definecolor{flag-color}{HTML}{009688}      % Teal
\definecolor{yescolor}{RGB}{200, 255, 200}  % Light green
\definecolor{nocolor}{RGB}{255, 200, 200}   % Light red
\definecolor{headerblue}{RGB}{225, 238, 255}
\definecolor{spaceblack}{HTML}{403E3D}

% NTNU color scheme
\definecolor{ntnu-blue}{HTML}{00509e}
\definecolor{ntnu-red}{HTML}{E40125}
\definecolor{ntnu-green}{HTML}{BCD025}
\definecolor{ntnu-lightblue}{HTML}{6096D0}
\definecolor{ntnu-orange}{HTML}{EF8114}
\definecolor{ntnu-sand}{HTML}{CFB887}
\definecolor{ntnu-magenta}{HTML}{B01B81}
\definecolor{ntnu-yellow}{HTML}{F7D019}
\definecolor{ntnu-purple}{HTML}{482776}
\definecolor{ntnu-turquoise}{HTML}{3CBFBE}

% State colors
\definecolor{state-sand}{HTML}{CFB887}
\definecolor{state-yellow}{HTML}{F7D019}
\definecolor{state-magenta}{HTML}{D5006D}
\definecolor{state-turquoise}{HTML}{00BFA5}
\definecolor{state-green}{HTML}{00BFA5}
\definecolor{state-orange}{HTML}{FF6F00}
\definecolor{state-gray}{HTML}{B0BEC5}
\colorlet{state-blue}{thm-color!75}
\colorlet{state-red}{red!80}


% Language-dependent theorem names
\addto\captionsenglish{%
  \def\definitionname{Definition}%
  \def\theoremname{Theorem}%
  \def\lemmaname{Lemma}%
  \def\examplename{Example}%
  \def\remarkname{Remark}%
  \def\propositionname{Proposition}%
  \def\corollaryname{Corollary}%
  \def\solutionname{Solution}%
}

\addto\captionsnorsk{%
  \def\definitionname{Definisjon}%
  \def\theoremname{Teorem}%
  \def\lemmaname{Lemma}%
  \def\examplename{Eksempel}%
  \def\remarkname{Bemerkning}%
  \def\propositionname{Proposisjon}%
  \def\corollaryname{Korollar}%
  \def\solutionname{LÃ¸sning}%
}


% Theorem environments
\tcbset{
  base theorem style/.style={
      enhanced,
      fonttitle=\bfseries,
      breakable,
      before skip=10pt,
      after skip=10pt,
      separator sign={.},
      sharp corners
    }
}

\newtcbtheorem{definition}{\definitionname}{%
  enhanced jigsaw,
  colback=def-color!10,
  colframe=def-color!80!black,
  fonttitle=\bfseries,
  coltitle=black,
  attach boxed title to top left={xshift=10pt,yshift=-\tcboxedtitleheight/2},
  boxed title style={
      colback=def-color!10,
      colframe=def-color!80!black,
      height=16pt,
      bean arc,
    %    overlay={
    %   \node[anchor=west] (icon) at (frame.east) {
    %     \begin{tikzpicture}
    %       \node[circle, fill=def-color!80!black, inner sep=1pt, minimum size=16pt] (c) {\color{white}\bfseries !};
    %     \end{tikzpicture}
    %   };
    % },
    },
  separator sign=.,
  label separator={},
  sharp corners,
  top=6pt,
  bottom=2pt,
  left=2pt,
  right=2pt,
  before skip=12pt,
  after skip=12pt,
  breakable,
  boxrule=1pt
}{def}

\newtcbtheorem{theorem}{\theoremname}{%
  enhanced jigsaw,
  colback=thm-color!10,
  colframe=thm-color!80!black,
  fonttitle=\bfseries,
  coltitle=black,
  attach boxed title to top left={xshift=10pt,yshift=-\tcboxedtitleheight/2},
  boxed title style={
      colback=thm-color!10,
      colframe=thm-color!80!black,
      height=16pt,
      bean arc
    },
  separator sign=.,
  label separator={},
  sharp corners,
  top=6pt,
  bottom=2pt,
  left=2pt,
  right=2pt,
  before skip=10pt,
  after skip=10pt,
  breakable
}{thm}

\newtcbtheorem{lemma}{\lemmaname}{%
  enhanced jigsaw,
  colback=lem-color!10,
  colframe=lem-color!80!black,
  boxrule=0pt,
  fonttitle=\bfseries,
  attach boxed title to top left={yshift=-\tcboxedtitleheight},
  boxed title style={
      boxrule=0pt,
      boxsep=2pt,
      colback=lem-color!80!black,
      colframe=lem-color!80!black,
      interior code={\fill[lem-color!80!black]
          (interior.north west)--
          (interior.south west)--
          ([xshift=-2mm]interior.south east)--
          ([xshift=2mm]interior.north east)--cycle;
        }
    },
  separator sign=.,
  label separator={},
  frame hidden,
  borderline north={1pt}{0pt}{lem-color!80!black},
  before upper={\hspace{\tcboxedtitlewidth}},
  sharp corners,
  top=2pt,
  bottom=2pt,
  left=5pt,
  right=5pt,
  before skip=10pt,
  after skip=10pt,
  breakable
}{lem}

\newtcbtheorem{example}{\examplename}{%
  base theorem style,
  colback=white,
  colframe=white,
  borderline west={1.5pt}{0pt}{exm-color},
  left=8pt,
  before skip=10pt,
  after skip=10pt,
  coltitle=exm-color,
}{ex}

\NewTColorBox{solution}{ O{} }{%
  enhanced,
  colback=white,
  colframe=white,
  borderline east={1.5pt}{0pt}{rem-color},
  left=8pt,
  right=4pt,
  top=4pt,
  bottom=4pt,
  before skip=10pt,
  after skip=10pt,
  breakable,
  sharp corners,
  boxrule=0pt,
  frame hidden,
  parbox=false,
  overlay={
    \node[rotate=-90, anchor=south west,font=\tiny\bfseries]
      at ([yshift=3pt, xshift=-2pt]frame.north east) {\MakeUppercase{\solutionname}};
  },
}

\newtcbtheorem{remark}{\remarkname}{%
  base theorem style,
  colback=white,
  colframe=white,
  borderline west={1.5pt}{0pt}{rem-color},
  left=8pt,
  before skip=10pt,
  after skip=10pt,
  coltitle=black
}{rem}

\newtcbtheorem[no counter]{motivation}{}{%
  base theorem style,
  colback=white,
  colframe=white,
  borderline west={1.5pt}{0pt}{mot-color},
  left=8pt,
  boxsep=2pt,
  before skip=10pt,
  after skip=10pt,
  coltitle=black,
}{mot}

\newtcbtheorem{proposition}{\propositionname}{
  enhanced jigsaw,
  colback=prop-color!10,
  colframe=prop-color!80!black,
  fonttitle=\bfseries,
  attach boxed title to top left={yshift=-\tcboxedtitleheight},
  boxed title style={
      boxrule=0pt,
      boxsep=2.5pt,
      colback=prop-color!80!black,
      colframe=prop-color!80!black,
      sharp corners=uphill
    },
  separator sign=.,
  label separator={},
  top=\tcboxedtitleheight,
  bottom=2pt,
  left=2pt,
  right=2pt,
  before skip=10pt,
  after skip=10pt,
  breakable
}{prop}

\newtcbtheorem{corollary}{\corollaryname}{%
  enhanced jigsaw,
  colback=cor-color!10,
  colframe=cor-color!80!black,
  fonttitle=\bfseries,
  coltitle=black,
  attach boxed title to top left={xshift=10pt,yshift=-\tcboxedtitleheight/2},
  boxed title style={
      colback=cor-color!10,
      colframe=cor-color!80!black,
      height=16pt,
      bean arc
    },
  separator sign=.,
  label separator={},
  sharp corners,
  top=6pt,
  bottom=2pt,
  left=2pt,
  right=2pt,
  before skip=10pt,
  after skip=10pt,
  breakable
}{cor}

\definecolor{property-color}{HTML}{FF9800} % Vibrant orange

\newtcbtheorem{property}{Property}{%
  enhanced jigsaw,
  colback=property-color!10,
  colframe=property-color!90!black,
  fonttitle=\bfseries,
  coltitle=black,
  attach boxed title to top left={xshift=10pt,yshift=-\tcboxedtitleheight/2},
  boxed title style={
      colback=property-color!10,
      colframe=property-color!90!black,
      height=16pt,
      bean arc
    },
  separator sign=.,
  label separator={},
  sharp corners,
  top=6pt,
  bottom=2pt,
  left=2pt,
  right=2pt,
  before skip=10pt,
  after skip=10pt,
  breakable
}{prop}

\definecolor{properties-color}{HTML}{00B8A9} % Vibrant teal


\renewenvironment{proof}[1][\proofname]{%
  \begin{tcolorbox}[
      blanker,
      breakable,
      borderline west={1.5pt}{0pt}{thm-color},
      before skip=10pt,
      after skip=10pt,
      left=8pt,
      right=4pt,
      colback=thm-color!10,
      colframe=thm-color!80!black
    ]
    \textbf{#1}.\par\vspace{2pt}
    }{\hfill\qed\end{tcolorbox}}
  % Updated box environments

\newtcolorbox{filingbox}[2][]{%
enhanced jigsaw,
  breakable,
  colback=filing-color!10,
  colframe=filing-color!80!black,
  fonttitle=\bfseries,
  coltitle=black,
  attach boxed title to top left={xshift=10pt,yshift=-\tcboxedtitleheight/2},
  boxed title style={
      colback=filing-color!10,
      colframe=filing-color!80!black,
      height=16pt,
      bean arc
    },
  title={#2},
  before skip=10pt,
  after skip=10pt,
  top=6pt,
  bottom=2pt,
  left=2pt,
  right=2pt,
  #1
}

\newtcbtheorem{gulark}{Gulark}{%
  enhanced jigsaw,
  colback=ntnu-yellow!10,
  colframe=ntnu-yellow!80!black,
  fonttitle=\bfseries,
  coltitle=black,
  attach boxed title to top left={xshift=10pt,yshift=-\tcboxedtitleheight/2},
  boxed title style={
      colback=ntnu-yellow!10,
      colframe=ntnu-yellow!80!black,
      height=16pt,
      bean arc
    },
  separator sign=.,
  label separator={},
  sharp corners,
  top=6pt,
  bottom=2pt,
  left=2pt,
  right=2pt,
  before skip=10pt,
  after skip=10pt,
  breakable
}{gulark}

\newtcolorbox{flagbox}[2][]{enhanced jigsaw,
  breakable,
  colback=flag-color!10,
  colframe=flag-color!80!black,
  boxrule=0pt,
  fonttitle=\bfseries,
  coltitle=black,
  title={#2},
  attach title to upper,
  frame hidden,
  borderline west={2pt}{0pt}{flag-color},
  sharp corners,
  top=2pt,
  bottom=2pt,
  left=5pt,
  right=5pt,
  before skip=10pt,
  after skip=10pt,
  #1
}

% =============================================
% 7. GRAPHICS & TIKZ
% =============================================
\usepackage{standalone}
\usepackage{pgfplots}
\pgfplotsset{compat=newest}
\usetikzlibrary{arrows.meta, backgrounds, positioning, calc, patterns}
\usepgfplotslibrary{fillbetween}
\tikzset{>=Latex}

\endinput